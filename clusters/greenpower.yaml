---
name: Green Power
types:

  MaxSinkTableEntries: &maxSinkTableEntries
    name: Max Sink Table Entries
    description: that can be stored in GPS
    id: "0x0000"
    type: u8
    access: r
    default: "5"
    required: true
  # Sink table -- see page 89
  # https://zigbeealliance.org/wp-content/uploads/2019/11/docs-09-5499-26-batt-zigbee-green-power-specification.pdf
  SinkTable: &sinkTable
    name: Sink Table
    description: contains the pairings configured for this GPS
    id: "0x0001"
    type: lostring # change to local struct
    access: r
    required: true
  CommunicationMode: &communicationMode
    name: Communication Mode
    id: "0x0002"
    type: enum8
    access: rw
    default: "1"
    required: true
    values:
      "0x00": Full Unicast
      "0x01": Groupcast
      "0x02": Pre-commissioned Groupcast
      "0x03": Lightweight Unicast
  CommissioningExitMode: &commissioningExitMode
    name: Commissioning Exit Mode
    description: controls when GPS exits commissioning mode
    id: "0x0003"
    type: bmp8
    access: rw
    default: "2"
    required: true
    bits:
      "0": On expiration
      "1": On pairing success
      "2": On exit command
  CommissioningWindow: &commissioningWindow
    name: Commissioning Window
    id: "0x0004"
    type: u16
    unit: Seconds
    access: rw
    default: "5"
    required: false
  SecurityLevel: &securityLevel
    name: Security Level
    id: "0x0005"
    type: enum8
    access: rw
    default: "1"
    required: true
    values:
      "0x00": No security
      "0x01": LSB of frame counter and short MIC # Least significant byte, 2B MIC
      "0x02": Full frame counter and long MIC # 4B MIC
      "0x03": Encryption, Full frame counter and long MIC # 4B MIC
  Functionality: &functionality
    name: Functionality
    id: "0x0006"
    type: bmp24
    access: r
    required: true
    bits: &functionalityBits
      "0": GP Feature
      "1": Direct Communication
      "2": Derived Groupcast communication
      "3": Pre-commissioned Groupcast communication
      "4": Unicast communication
      "5": Lightweight unicast communication
      "6": Single-hop bidirectional operation
      "7": Multi-hop bidirectional operation
      "8": Proxy table maintenance
      "9": Single-hop commissioning
      "10": Multi-hop commissioning
      "11": CT-based commissioning
      "12": Maintenance of GPD
      "13": Security Support - No security
      "14": Security Support - LSB of frame counter and short MIC # Least significant byte, 2B MIC
      "15": Security Support - Full frame counter and long MIC # 4B MIC
      "16": Security Support - Encryption, Full frame counter and long MIC # 4B MIC
      "17": Sink table-based groupcast forwarding
      "18": Translation table
      "19": GPD IEEE Address
  ActiveFunctionality: &activeFunctionality
    name: Active Functionality
    id: "0x0007"
    type: bmp24
    access: r
    default: "0xffffff"
    required: true
    bits: *functionalityBits

  SharedSecurityKeyType: &sharedSecurityKeyType
    name: Shared Security Key Type
    id: "0x0020"
    type: enum8
    range: "0x00,0x08"
    access: rw
    default: "3"
    required: false
    values:
      "0x00": No key
      "0x01": NWK key
      "0x02": GP Group key
      "0x03": NWK-key derived GP group key
      "0x07": Dervied Individual GPD key
  SharedSecurityKey: &sharedSecurityKey
    name: Shared Security Key
    id: "0x0021"
    type: seckey
    access: rw
    required: false
  LinkKey: &linkKey
    name: Link Key
    id: "0x0022"
    type: seckey
    access: rw
    required: false
    default: "ZigBeeAlliance09"


  PairingOptions: &pairingOptions
    name: Pairing options
    type: u24 #bmp24?
  IeeeAddress: &ieee
    name: IEEE Address
    description: is a 64-bit MAC address
    type: uid
  SourceId: &sourceId
    name: Source id
    type: u32
  GroupId: &groupId
    name: Group id
    type: u16
  DeviceId: &deviceId
    name: Device id
    type: enum8
    values:
      "0x00": "One State Switch"
      "0x01": "Two State Switch"
      "0x02": "On/Off Switch"
      "0x03": "Level Control Switch"
      "0x04": "Sensor"
      "0x05": "Advanced One State Switch"
      "0x06": "Advanced Two State Switch"
  FrameCounter: &frameCounter
    name: Frame counter
    type: u32
  Key: &key
    name: Key
    type: seckey # 128 bit key
  CommissioningOptions: &commissioningOptions
    name: Commissioning Options
    type: bmp8
    bits:
      "0": "Enter"
      "1": "Exit on expire"
      "2": "Exit on pairing"
      "3": "Exit on command"
      "4": "Unicast"
  NotificationOptions: &notificationOptions
    name: Notification Options
    type: bmp16 #bmp16?
    bits:
      "1": IEEE Address
      "3": Also unicast
      "4": Also derived group
      "5": Also commissioned group
      # should be combined to get 2 bit security level
      "6": Security Level 1
      "7": Security Level 2
      # should be combined to get 3 bit security type
      "8": Security key type 1
      "9": Security key type 2
      "10": Security key type 3
      "11": Appoint Temp Master
      "12": Proxy TX Queue Full
  CommissioningNotificationOptions: &commissioningNotificationOptions
    name: Commissioning Notification Options
    type: bmp16
    # listed as enum16, but easier to read as bmp16
    # this means the endianness is wrong - so bit 0 = 8 and 8 = 0
    bits:
      "1": Security processing failed
      "2": Bidirectional
      "3": Proxy Info Present

      "9": IEEE Address
      "11": Rx After Tx
      # should be combined to get 2 bit security level
      "12": Security Level Bit1
      "13": Security Level Bit2
      #"12..13": Security Level
      # should be combined to get 3 bit security type
      "0": Security Key Bit1
      "14": Security Key Bit2
      "15": Security Key Bit3
      #"0,14..15": Security key
  ProxyShortAddress: &proxyShortAddress
    name: Proxy Short Address
    type: u16
  ProxyLinkQuality: &proxyLinkQuality
    name: Proxy Link Quality
    type: u8
    description: upper 2 bits contains signal strength (00=Poor, 01=Moderate, 10=High, 11=Excellent), lower 6 bits contains RSSI
  Mic: &mic
    name: Mic
    description: Is used for security verification
    type: u32

  CommandId: &commandId
    name: Command id
    type: enum8
    values:
      "0x00": "Identify"
      "0x10": "Scene 0"
      "0x11": "Scene 1"
      "0x12": "Scene 2"
      "0x13": "Scene 3"
      "0x14": "Scene 4"
      "0x15": "Scene 5"
      "0x16": "Scene 6"
      "0x17": "Scene 7"
      "0x18": "Scene 8"
      "0x19": "Scene 9"
      "0x1a": "Scene 10"
      "0x1b": "Scene 11"
      "0x1c": "Scene 12"
      "0x1d": "Scene 13"
      "0x1e": "Scene 14"
      "0x1f": "Scene 15"
      "0x20": "Off"
      "0x21": "On"
      "0x22": "Toggle"
      "0x23": "Release"
      "0x30": "Move up"
      "0x31": "Move down"
      "0x32": "Step up"
      "0x33": "Step down"
      "0x34": "Level control stop"
      "0x35": "Move up with on/off"
      "0x36": "Move down with on/off"
      "0x37": "Step up with on/off"
      "0x38": "Step down with on/off"
      "0x40": "Move hue stop"
      "0x41": "Move hue up"
      "0x42": "Move hue down"
      "0x43": "Step hue up"
      "0x44": "Step hue down"
      "0x45": "Move saturation stop"
      "0x46": "Move saturation up"
      "0x47": "Move saturation down"
      "0x48": "Step saturation up"
      "0x49": "Step saturation down"
      "0x4A": "Move color"
      "0x4B": "Step color"
      "0x50": "Lock door"
      "0x51": "Unlock door"
      "0x60": "Press 1 of 1"
      "0x61": "Release 1 of 1"
      "0x62": "Press 1 of 2"
      "0x63": "Release 1 of 2"
      "0x64": "Press 2 of 2"
      "0x65": "Release 2 of 2"
      "0x66": "Short press 1 of 1"
      "0x67": "Short press 1 of 2"
      "0x68": "Short press 2 of 2"
      "0xA0": "Attribute reporting"
      "0xA1": "Custom Attribute reporting"
      "0xA2": "Multi-cluster reporting"
      "0xA3": "Custom multi-cluster reporting"
      "0xA4": "Request attributes"
      "0xA5": "Read attributes response"
      "0xAF": "Sensor command"
      "0xE0": "Commissioning"
      "0xE1": "Decommissioning"
      "0xE2": "Success"
      "0xE3": "Channel request"
      "0xF0": "Commissioning reply"
      "0xF1": "Write attributes"
      "0xF2": "Read attributes"
      "0xF3": "Channel configuration"
  PayloadLength: &payloadLength
    name: Payload length
    type: u8
  CommandFrame: &commandFrame
    name: Command frame
    type: ostring

clusters:
  - id: "0x0021"
    profile: "0xa1e0"
    name: Green Power
    server:
      attr:
        - *maxSinkTableEntries
        - *sinkTable
        - *communicationMode
        - *commissioningExitMode
        - *commissioningWindow
        - *securityLevel
        - *functionality
        - *activeFunctionality
        # Shared attributes
        - *sharedSecurityKeyType
        - *sharedSecurityKey
        - *linkKey
      cmd:
        - id: "0x00"
          name: Notification
          dir: recv
          required: o
          payloadattr:
            - *notificationOptions
            - <<: *sourceId
              cond:
                - name: Notification Options
                  bit: IEEE Address
                  invert: true
            - <<: *ieee
              cond:
                - name: Notification Options
                  bit: IEEE Address
            - *frameCounter
            - *commandId
            - *payloadLength
            - *commandFrame

        - id: "0x04"
          name: Commissioning Notification
          dir: recv
          required: m
          payloadattr:
            - *commissioningNotificationOptions
            - <<: *sourceId
              cond:
                - name: Commissioning Notification Options
                  bit: IEEE Address
                  invert: true
            - <<: *ieee
              cond:
                - name: Commissioning Notification Options
                  bit: IEEE Address
            - *frameCounter
            - *commandId
            - *commandFrame
            - <<: *proxyShortAddress
              cond:
                - name: Commissioning Notification Options
                  bit: Proxy Info Present
            - <<: *proxyLinkQuality
              cond:
                - name: Commissioning Notification Options
                  bit: Proxy Info Present
            - *mic

    client:
      attr:
        # Shared attributes
        - *sharedSecurityKeyType
        - *sharedSecurityKey
        - *linkKey
        # Client attributes
      cmd:

        - id: "0x01"
          name: Pairing
          dir: send
          required: m
          payloadattr:
            - *pairingOptions
            - *sourceId
            - *groupId
            - *deviceId
            - *frameCounter
            - *key
        - id: "0x02"
          name: Commissioning Mode
          dir: send
          required: m
          payloadattr:
            - *commissioningOptions
            - <<: *commissioningWindow
              cond:
                - name: "Commissioning Options"
                  bit: "Enter"
                - name: "Commissioning Options"
                  bit: "Exit on expire"
